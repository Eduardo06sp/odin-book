<h2>Your feed</h2>

<div class="new-post-container">
  <div class="current-user-avatar">
  <% if current_user.avatar.attached? %>
    <%= image_tag current_user.avatar.representation(resize_to_fill: [180, 180]).processed.url %>
  <% end %>
  </div>

  <%= form_with model: @post, class: 'new-post-form' do |form| %>
    <%= form.text_area :content %>
    <dialog>
      <%= form.url_field :image_url %>
      <%= form.file_field :image %>
      <button type="button">Cancel</button>
    </dialog>
    <button type="button">Attach Image</button>
    <%= form.submit %>
  <% end %>
</div>

<ul>
<% @posts.each do |post| %>
  <li>
    <% if current_user.id == post.user_id %>
      <%= link_to 'Delete this post', post_path(post.id), data: {
        turbo_method: :delete,
        turbo_confirm: 'Are you sure you want to delete this post?' } %>
    <% end %>

    <%= post.user.email %>
    <% if post.image.attached? %>
      <%= image_tag post.image.representation(resize_to_fit: [nil, 500]).processed.url %>
    <% end %>
    <%= post.content %>
    <% if post.liking_users.include?(current_user) %>
      <% like = Like.find_by(post:, user: current_user) %>
      <%= button_to 'Unlike', like_path(like), method: :delete %>
    <% else %>
      <%= button_to 'Like', likes_path, params: { post:, user: current_user } %>
    <% end %>
    <p>
    Liked by
    <% post.liking_users.each do |user| %>
      <%= user.email %>
    <% end %>
    </p>

    <%= form_with model: Comment.new do |form| %>
      <%= hidden_field_tag 'comment[post_id]', post.id %>
      <%= form.text_field :content %>
      <%= form.submit %>
    <% end %>

    <ul>
      <% post.comments.each do |comment| %>
        <li><%= comment.user.email %> <%= comment.content %></li>
      <% end %>
    </ul>
  </li>
<% end %>
</ul>
