<h2>Your feed</h2>

<div class="new-post-container">
  <div class="current-user-avatar">
  <% if current_user.avatar.attached? %>
    <%= image_tag current_user.avatar.representation(resize_to_fill: [180, 180]).processed.url %>
  <% end %>
  </div>

  <%= form_with model: @post, class: 'new-post-form', data: { controller: "modal" } do |form| %>
    <%= form.text_area :content %>
    <dialog data-modal-target="modal">
      <%= form.url_field :image_url, data: { 'modal-target': 'uploadUrl' } %>
      <%= form.file_field :image, data: { 'modal-target': 'uploadFile' } %>
      <div class="new-post-attachment-options">
        <button type="button" data-action="click->modal#close">Save</button>
        <button type="button" data-action="click->modal#cancel">Cancel</button>
      </div>
    </dialog>
    <button type="button" data-action="click->modal#display">Attach Image</button>
    <%= form.submit %>
  <% end %>
</div>

<div class="feed-posts">
  <% @posts.each do |post| %>

    <div class="post">
      <% if current_user.id == post.user_id %>
        <%= link_to 'Delete this post', post_path(post.id), data: {
          turbo_method: :delete,
          turbo_confirm: 'Are you sure you want to delete this post?' } %>
      <% end %>

      <%= post.user.email %>
      <% if post.image.attached? %>
        <%= image_tag post.image.representation(resize_to_fit: [nil, 500]).processed.url %>
      <% end %>
      <%= post.content %>
      <% if post.liking_users.include?(current_user) %>
        <% like = Like.find_by(post:, user: current_user) %>
        <%= button_to 'Unlike', like_path(like), method: :delete %>
      <% else %>
        <%= button_to 'Like', likes_path, params: { post:, user: current_user } %>
      <% end %>
      <p>
      Liked by
      <% post.liking_users.each do |user| %>
        <%= user.email %>
      <% end %>
      </p>

      <%= form_with model: Comment.new do |form| %>
        <%= hidden_field_tag 'comment[post_id]', post.id %>
        <%= form.text_field :content %>
        <%= form.submit %>
      <% end %>

      <ul>
        <% post.comments.each do |comment| %>
          <li><%= comment.user.email %> <%= comment.content %></li>
        <% end %>
      </ul>
    </div>

  <% end %>
</div>
