<h2>Your feed</h2>

<div class="new-post-container">
  <div class="current-user-avatar">
  <% if current_user.avatar.attached? %>
    <%= image_tag current_user.avatar.representation(resize_to_fill: [180, 180]).processed.url %>
  <% end %>
  </div>

  <%= form_with model: @post, class: 'new-post-form', data: { controller: "modal" } do |form| %>
    <%= form.text_area :content %>
    <dialog data-modal-target="modal">
      <%= form.url_field :image_url, data: { 'modal-target': 'uploadUrl' } %>
      <%= form.file_field :image, data: { 'modal-target': 'uploadFile' } %>
      <div class="new-post-attachment-options">
        <button type="button" data-action="click->modal#close">Save</button>
        <button type="button" data-action="click->modal#cancel">Cancel</button>
      </div>
    </dialog>
    <button type="button" data-action="click->modal#display">Attach Image</button>
    <%= form.submit %>
  <% end %>
</div>

<div class="feed-posts">
  <% @posts.each do |post| %>

    <div class="post">
      <div class="post-heading">
        <div class="post-avatar">
          <% if post.user.avatar.attached? %>
            <%= image_tag post.user.avatar.representation(resize_to_fill: [180, 180]).processed.url %>
          <% end %>
        </div>

        <p><%= post.user.username.present? ? post.user.username : post.user.email %></p>

        <% if current_user.id == post.user_id %>
          <%= link_to 'Delete this post', post_path(post.id), data: {
            turbo_method: :delete,
            turbo_confirm: 'Are you sure you want to delete this post?' } %>
        <% end %>
      </div>

      <p class="post-content"><%= post.content %></p>

      <% if post.image.attached? %>
        <div class="post-image">
          <%= image_tag post.image.representation(resize_to_fit: [nil, 500]).processed.url %>
        </div>
      <% end %>

      <p class="post-liked-by">
      <% if post.liking_users.length > 0 %>
        Liked by
        <% post.liking_users.each do |user| %>
          <%= user.username.present? ? post.user.username : post.user.email %>
        <% end %>
      <% else %>
        Be the first to like this post!
      <% end %>
      </p>

      <div class="post-like-unlike-form">
        <% if post.liking_users.include?(current_user) %>
          <% like = Like.find_by(post:, user: current_user) %>
          <%= button_to 'Unlike', like_path(like), method: :delete, class: 'post-unlike-button' %>
        <% else %>
          <%= button_to 'Like', likes_path, params: { post:, user: current_user }, class: 'post-like-button'%>
        <% end %>
      </div>

      <div class="comments-section" data-controller="comment">
        <button type="button" class="comments-toggle"  data-action="click->comment#toggleVisibility">X Comments</button>

        <%= form_with model: Comment.new, class: 'new-comment-form hidden', data: { 'comment-target': 'newCommentForm' } do |form| %>
          <%= hidden_field_tag 'comment[post_id]', post.id %>
          <%= form.text_area :content %>
          <%= form.submit %>
        <% end %>

        <div class="post-comments hidden" data-comment-target="comments">
          <% post.comments.each do |comment| %>
            <div class="comment">
              <div class="comment-avatar">
                <% if comment.user.avatar.attached? %>
                  <%= image_tag comment.user.avatar.representation(resize_to_fill: [180, 180]).processed.url %>
                <% end %>
              </div>
              <p class="comment-name"><%= comment.user.email %></p>
              <p class="comment-content"><%= comment.content %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

  <% end %>
</div>
